{# ---- variables & defaults ---- #}
{%- set svc = project_name ~ '-' ~ (service | replace('_','-')) -%}
{%- set volumes = volumes | default({}) -%}
{%- set service_port = service_port | default(0) -%}
{%- set expose_method = expose_method | default('nodeport') -%}
{%- set probes_enabled = probes_enabled | default(true) -%}
{%- set probe_kind = probe_kind | default('tcp') -%} {# 'tcp' or 'http' #}
{%- set probe_path = probe_path | default('/') -%}
{%- set pod_fs_group = pod_fs_group | default(0) -%}
{%- set probe_port = probe_port | default(service_port) -%}
{%- set initial_readiness_delay = initial_readiness_delay | default(5) -%}
{%- set initial_liveness_delay = initial_liveness_delay | default(15) -%}
{%- set storage_class_name = storage_class_name | default(None) -%}
{%- set resources = resources | default({'requests': {'cpu': '100m','memory':'128Mi'}, 'limits': {'cpu': '1','memory':'512Mi'}}) -%}
{%- set security_context = security_context | default({
  'runAsNonRoot': True,
  'allowPrivilegeEscalation': False,
  'readOnlyRootFilesystem': False,
  'seccompProfile': {'type': 'RuntimeDefault'},
  'capabilities': {'drop': ['ALL']}
}) -%}

{%- set secret_keys = (secret_keys | default([])) | select('in', env_vars.keys()) | list -%}
---
apiVersion: v1
kind: Namespace
metadata:
  name: {{ project_name }}

---
{# ---- optional Secret for sensitive env vars ---- #}
{% if secret_keys %}
apiVersion: v1
kind: Secret
metadata:
  name: {{ svc }}-env
  namespace: {{ project_name }}
type: Opaque
stringData:
{% for k in secret_keys | sort %}
  {{ k }}: "{{ env_vars[k] }}"
{% endfor %}

{% endif %}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ svc }}
  namespace: {{ project_name }}
  labels:
    app.kubernetes.io/part-of: {{ project_name }}
spec:
  selector:
    app: {{ svc }}
{% if service_port|int > 0 %}
  ports:
    - port: {{ service_port }}
      targetPort: {{ service_port }}
{% endif %}
  type:
{% if expose_method == 'hostport' %}
    ClusterIP
{% elif expose_method == 'nodeport' %}
    NodePort
{% else %}
    LoadBalancer
{% endif %}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ svc }}
  namespace: {{ project_name }}
  labels:
    app.kubernetes.io/name: {{ service | replace('_','-') }}
    app.kubernetes.io/instance: {{ svc }}
    app.kubernetes.io/part-of: {{ project_name }}
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: {{ svc }}
  template:
    metadata:
      labels:
        app: {{ svc }}
        app.kubernetes.io/name: {{ service | replace('_','-') }}
        app.kubernetes.io/instance: {{ svc }}
        app.kubernetes.io/part-of: {{ project_name }}
    spec:
{% if expose_method == 'hostport' %}
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
{% endif %}
      securityContext:
        fsGroup: {{ pod_fs_group }}
      containers:
        - name: {{ service | replace('_','-') }}
          image: {{ image }}
{% if service_port|int > 0 %}
          ports:
            - containerPort: {{ service_port }}
{% if expose_method == 'hostport' %}
              hostPort: {{ service_port }}
{% endif %}
              name: {{ service | replace('_','-') }}
{% endif %}

{% if env_vars %}
          env:
{% for key, val in (env_vars | default({})) | dictsort %}
{% if key in secret_keys %}
            - name: {{ key }}
              valueFrom:
                secretKeyRef:
                  name: {{ svc }}-env
                  key: {{ key }}
{% else %}
            - name: {{ key }}
              value: {{ val }}
{% endif %}
{% endfor %}
{% endif %}

{% if probes_enabled and probe_port|int > 0 %}
          readinessProbe:
{% if probe_kind == 'http' %}
            httpGet:
              path: {{ probe_path }}
              port: {{ probe_port }}
{% else %}
            tcpSocket:
              port: {{ probe_port }}
{% endif %}
            initialDelaySeconds: {{ initial_readiness_delay }}
            periodSeconds: 5
          livenessProbe:
{% if probe_kind == 'http' %}
            httpGet:
              path: {{ probe_path }}
              port: {{ probe_port }}
{% else %}
            tcpSocket:
              port: {{ probe_port }}
{% endif %}
            initialDelaySeconds: {{ initial_liveness_delay }}
            periodSeconds: 10
{% endif %}

          resources:
            requests:
              cpu: "{{ resources.requests.cpu }}"
              memory: "{{ resources.requests.memory }}"
            limits:
              cpu: "{{ resources.limits.cpu }}"
              memory: "{{ resources.limits.memory }}"
          securityContext:
            runAsNonRoot: {{ security_context.runAsNonRoot | default(true) | tojson }}
            allowPrivilegeEscalation: {{ security_context.allowPrivilegeEscalation | default(false) | tojson }}
            readOnlyRootFilesystem: {{ security_context.readOnlyRootFilesystem | default(false) | tojson }}
            {% if security_context.capabilities is defined %}capabilities: {{ security_context.capabilities | tojson }}{% endif %}
            {% if security_context.seccompProfile is defined %}seccompProfile: {{ security_context.seccompProfile | tojson }}{% endif %}

{% if volumes %}
          volumeMounts:
{% for name, cfg in volumes | dictsort %}
            - name: {{ name | lower }}
              mountPath: {{ cfg.mountPath }}
{% endfor %}
{% endif %}

{% if volumes %}
      volumes:
{% for name, cfg in volumes | dictsort %}
        - name: {{ name | lower }}
{% if cfg.pvc is defined %}
          persistentVolumeClaim:
            claimName: {{ cfg.pvc }}
{% elif cfg.hostPath is defined %}
          hostPath:
            path: {{ cfg.hostPath }}
            type: DirectoryOrCreate
{% endif %}
{% endfor %}
{% endif %}

{% if volumes %}
{% for name, cfg in volumes | dictsort if cfg.pvc is defined %}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ name | lower }}
  namespace: {{ project_name }}
spec:
  accessModes:
    - {{ (cfg.accessMode | default('ReadWriteOnce')) }}
  resources:
    requests:
      storage: {{ (cfg.size | default('1Gi')) }}
{% if storage_class_name %}
  storageClassName: {{ storage_class_name }}
{% endif %}
{% endfor %}
{% endif %}
