{# ---- variables & defaults ---- #}
{%- set svc = project_name ~ '-' ~ (service | replace('_','-')) -%}
{%- set volumes = volumes | default({}) -%}
{%- set service_port = service_port | default(0) -%}
{%- set expose_method = expose_method | default('nodeport') -%}   {# 'hostport' | 'nodeport' | 'loadbalancer' | 'clusterip' #}
{%- set probes_enabled = probes_enabled | default(true) -%}
{%- set probe_kind = probe_kind | default('tcp') -%}               {# 'tcp' or 'http' or 'exec' (see exec_cmd) #}
{%- set probe_path = probe_path | default('/') -%}
{%- set probe_port = probe_port | default(service_port) -%}
{%- set initial_readiness_delay = initial_readiness_delay | default(5) -%}
{%- set initial_liveness_delay = initial_liveness_delay | default(15) -%}
{%- set readiness_timeout = readiness_timeout | default(3) -%}
{%- set liveness_timeout = liveness_timeout | default(5) -%}
{%- set readiness_failures = readiness_failures | default(3) -%}
{%- set liveness_failures = liveness_failures | default(3) -%}
{%- set storage_class_name = storage_class_name | default(None) -%}
{%- set resources = resources | default({'requests': {'cpu': '100m','memory':'128Mi'}, 'limits': {'cpu': '1','memory':'512Mi'}}) -%}
{%- set security_context = security_context | default({'runAsNonRoot': True, 'allowPrivilegeEscalation': False, 'readOnlyRootFilesystem': False, 'seccompProfile': {'type': 'RuntimeDefault'}, 'capabilities': {'drop': ['ALL']}}) -%}
{%- set secret_keys = (secret_keys | default([])) | select('in', (env_vars | default({})).keys()) | list -%}
{%- set workload_kind = workload_kind | default('deployment') -%}
{%- set replicas = replicas | default(1) -%}
{%- set pod_fs_group = pod_fs_group | default(0) -%}
{%- set fsGroupChangePolicy = fsGroupChangePolicy | default('OnRootMismatch') -%}
{%- set image_pull_policy = image_pull_policy | default('IfNotPresent') -%}
{%- set termination_grace = termination_grace | default(30) -%}
{%- set revision_history = revision_history | default(3) -%}
{%- set node_port = node_port | default(None) -%}
{%- set exec_cmd = exec_cmd | default([]) -%}

---
apiVersion: v1
kind: Namespace
metadata:
  name: {{ project_name }}
  labels:
    app.kubernetes.io/part-of: {{ project_name }}

{# ---- optional Secret for sensitive env vars ---- #}
{% if secret_keys %}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ svc }}-env
  namespace: {{ project_name }}
type: Opaque
stringData:
{% for k in secret_keys | sort %}
  {{ k }}: "{{ env_vars[k] }}"
{% endfor %}
{% endif %}

{# ---- Service (headless for StatefulSet) ---- #}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ svc }}
  namespace: {{ project_name }}
  labels:
    app.kubernetes.io/name: {{ service | replace('_','-') }}
    app.kubernetes.io/instance: {{ svc }}
    app.kubernetes.io/part-of: {{ project_name }}
spec:
  selector:
    app: {{ svc }}
{% if service_port|int > 0 %}
  ports:
    - name: {{ service | replace('_','-') }}
      port: {{ service_port }}
      targetPort: {{ service_port }}
{% if workload_kind != 'statefulset' and expose_method == 'nodeport' and node_port %}
      nodePort: {{ node_port }}
{% endif %}
{% endif %}
{% if workload_kind == 'statefulset' %}
  clusterIP: None
{% else %}
  type: {{
    'ClusterIP' if expose_method == 'hostport'
    else 'NodePort' if expose_method == 'nodeport'
    else 'LoadBalancer' if expose_method == 'loadbalancer'
    else 'ClusterIP'
  }}
{% endif %}

{# ---- Workload (Deployment or StatefulSet) ---- #}
---
apiVersion: apps/v1
kind: {{ 'StatefulSet' if workload_kind == 'statefulset' else 'Deployment' }}
metadata:
  name: {{ svc }}
  namespace: {{ project_name }}
  labels:
    app.kubernetes.io/name: {{ service | replace('_','-') }}
    app.kubernetes.io/instance: {{ svc }}
    app.kubernetes.io/part-of: {{ project_name }}
spec:
{% if workload_kind == 'statefulset' %}
  serviceName: {{ svc }}
  podManagementPolicy: Parallel
  updateStrategy:
    type: RollingUpdate
{% else %}
  strategy:
    type: Recreate
{% endif %}
  revisionHistoryLimit: {{ revision_history }}
  replicas: {{ replicas }}
  selector:
    matchLabels:
      app: {{ svc }}
  template:
    metadata:
      labels:
        app: {{ svc }}
        app.kubernetes.io/name: {{ service | replace('_','-') }}
        app.kubernetes.io/instance: {{ svc }}
        app.kubernetes.io/part-of: {{ project_name }}
    spec:
{% if expose_method == 'hostport' %}
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
{% endif %}
      securityContext:
        fsGroup: {{ pod_fs_group }}
        fsGroupChangePolicy: {{ fsGroupChangePolicy }}
      containers:
        - name: {{ service | replace('_','-') }}
          image: {{ image }}
          imagePullPolicy: {{ image_pull_policy }}
{% if service_port|int > 0 %}
          ports:
            - containerPort: {{ service_port }}
              name: {{ service | replace('_','-') }}
{% if expose_method == 'hostport' %}
              hostPort: {{ service_port }}
{% endif %}
{% endif %}

{% if env_vars is defined and env_vars %}
          env:
{% for key, val in env_vars | dictsort %}
{% if key in secret_keys %}
            - name: {{ key }}
              valueFrom:
                secretKeyRef:
                  name: {{ svc }}-env
                  key: {{ key }}
{% else %}
            - name: {{ key }}
              value: {{ val | tojson }}
{% endif %}
{% endfor %}
{% endif %}

{% if probes_enabled and probe_kind in ['tcp','http','exec'] %}
{% set valid_port = (probe_port|int) if (probe_port is not none and (probe_port|string)|int > 0) else None %}
{% if probe_kind == 'exec' and exec_cmd %}
          readinessProbe:
            exec:
              command: {{ exec_cmd | tojson }}
            initialDelaySeconds: {{ initial_readiness_delay }}
            periodSeconds: 5
            timeoutSeconds: {{ readiness_timeout }}
            failureThreshold: {{ readiness_failures }}
            successThreshold: 1
          livenessProbe:
            exec:
              command: {{ exec_cmd | tojson }}
            initialDelaySeconds: {{ initial_liveness_delay }}
            periodSeconds: 10
            timeoutSeconds: {{ liveness_timeout }}
            failureThreshold: {{ liveness_failures }}
{% elif valid_port %}
          readinessProbe:
{% if probe_kind == 'http' %}
            httpGet:
              path: {{ probe_path }}
              port: {{ valid_port }}
{% else %}
            tcpSocket:
              port: {{ valid_port }}
{% endif %}
            initialDelaySeconds: {{ initial_readiness_delay }}
            periodSeconds: 5
            timeoutSeconds: {{ readiness_timeout }}
            failureThreshold: {{ readiness_failures }}
            successThreshold: 1
          livenessProbe:
{% if probe_kind == 'http' %}
            httpGet:
              path: {{ probe_path }}
              port: {{ valid_port }}
{% else %}
            tcpSocket:
              port: {{ valid_port }}
{% endif %}
            initialDelaySeconds: {{ initial_liveness_delay }}
            periodSeconds: 10
            timeoutSeconds: {{ liveness_timeout }}
            failureThreshold: {{ liveness_failures }}
{% endif %}
{% endif %}

          resources:
            requests:
              cpu: "{{ resources.requests.cpu }}"
              memory: "{{ resources.requests.memory }}"
            limits:
              cpu: "{{ resources.limits.cpu }}"
              memory: "{{ resources.limits.memory }}"

          securityContext:
{% if security_context.runAsUser is defined %}
            runAsUser: {{ security_context.runAsUser }}
{% endif %}
{% if security_context.runAsGroup is defined %}
            runAsGroup: {{ security_context.runAsGroup }}
{% endif %}
            runAsNonRoot: {{ security_context.runAsNonRoot | default(true) | tojson }}
            allowPrivilegeEscalation: {{ security_context.allowPrivilegeEscalation | default(false) | tojson }}
            readOnlyRootFilesystem: {{ security_context.readOnlyRootFilesystem | default(false) | tojson }}
{% if security_context.capabilities is defined %}
            capabilities: {{ security_context.capabilities | tojson }}
{% endif %}
{% if security_context.seccompProfile is defined %}
            seccompProfile: {{ security_context.seccompProfile | tojson }}
{% endif %}
{% if volumes %}
          volumeMounts:
{% for name, cfg in volumes | dictsort %}
            - name: {{ name | lower }}
              mountPath: {{ cfg.mountPath }}
{% endfor %}
{% endif %}

{% if lifecycle is defined %}
          lifecycle: {{ lifecycle | tojson }}
{% endif %}
      terminationGracePeriodSeconds: {{ termination_grace }}

{# --- Volume handling --- #}
{% if workload_kind == 'statefulset' %}
  {# Use volumeClaimTemplates in a StatefulSet #}
{% set pvc_vols = [] %}
{% for name, cfg in volumes | dictsort %}
{% if cfg.pvc is defined %}
{% set _ = pvc_vols.append({'name': name, 'cfg': cfg}) %}
{% endif %}
{% endfor %}
{% if pvc_vols %}
  volumeClaimTemplates:
{% for item in pvc_vols %}
    - metadata:
        name: {{ item.name | lower }}
      spec:
        accessModes:
          - {{ (item.cfg.accessMode | default('ReadWriteOnce')) }}
        resources:
          requests:
            storage: {{ (item.cfg.size | default('1Gi')) }}
{% if storage_class_name %}
        storageClassName: {{ storage_class_name }}
{% endif %}
{% endfor %}
{% endif %}
{% else %}
  {# Deployment: add volumes under the existing template.spec #}
{% if volumes %}
      volumes:
{% for name, cfg in volumes | dictsort %}
        - name: {{ name | lower }}
{% if cfg.pvc is defined %}
          persistentVolumeClaim:
            claimName: {{ (cfg.pvc.name | default(name | lower)) }}
{% elif cfg.hostPath is defined %}
          hostPath:
            path: {{ cfg.hostPath }}
            type: DirectoryOrCreate
{% endif %}
{% endfor %}
{% endif %}
{% endif %}

{# ---- Standalone PVCs (only for Deployment path) ---- #}
{% if workload_kind != 'statefulset' and volumes %}
{% for name, cfg in volumes | dictsort if cfg.pvc is defined %}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ (cfg.pvc.name | default(name | lower)) }}
  namespace: {{ project_name }}
spec:
  accessModes:
    - {{ (cfg.accessMode | default('ReadWriteOnce')) }}
  resources:
    requests:
      storage: {{ (cfg.size | default('1Gi')) }}
{% if storage_class_name %}
  storageClassName: {{ storage_class_name }}
{% endif %}
{% endfor %}
{% endif %}
