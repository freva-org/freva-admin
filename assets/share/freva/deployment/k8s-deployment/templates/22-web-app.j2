{%- set ns = project_name -%}
---
apiVersion: v1
kind: Service
metadata: { name: web-app, namespace: {{ ns }} }
spec:
  type: ClusterIP
  selector: { app: web-app }
  ports: [{ port: 8000, targetPort: 8000, name: http }]
---
apiVersion: v1
kind: ConfigMap
metadata: { name: wait-utils, namespace: {{ ns }} }
data:
  wait-for.sh: |
    #!/bin/sh
    set -e
    for host in database-server:3306 cache-server:6379 freva-rest-server:{{ freva_rest_port }}; do
      for i in $(seq 1 60); do
        nc -z $(echo $host | cut -d: -f1) $(echo $host | cut -d: -f2) && break
        sleep 1
      done
    done
    exit 0
---
apiVersion: apps/v1
kind: Deployment
metadata: { name: web-app, namespace: {{ ns }} }
spec:
  replicas: 1
  selector: { matchLabels: { app: web-app } }
  template:
    metadata: { labels: { app: web-app } }
    spec:
      securityContext: { fsGroup: {{ fs_group }} }
      initContainers:
        - name: wait-prereqs
          image: busybox:stable
          command: ["sh","-c","/bin/wait-for.sh"]
          volumeMounts:
            - { name: wait-script, mountPath: /bin/wait-for.sh, subPath: wait-for.sh }
      containers:
        - name: web
          image: ghcr.io/freva-org/freva-web:{{ web_version }}
          imagePullPolicy: {{ image_pull_policy }}
          env:
{% if use_core %}
            - { name: EVALUATION_SYSTEM_CONFIG_FILE, value: "{{ core_root_dir }}/freva/evaluation_system.conf" }
{% else %}
            - { name: EVALUATION_SYSTEM_CONFIG_FILE, value: "/data/config/evaluation_system.conf" }
{% endif %}
            - name: DJANGO_SUPERUSER_PASSWORD
              valueFrom: { secretKeyRef: { name: freva-secrets, key: MYSQL_ROOT_PASSWORD } }
            - { name: ALLOWED_HOSTS, value: "{{ web_allowed_hosts | join(',') }}" }
            - { name: FREVA_WEB_CONFIG_FILE, value: "/data/config/web/freva_web.toml" }
            - { name: SCHEDULER_HOST, value: "{{ web_scheduler_host | join(',') }}" }
            - { name: CSRF_TRUSTED_ORIGINS, value: "{{ web_csrf_trusted_origins | join(',') }}" }
            - { name: FREVA_BIN, value: "{{ web_freva_bin }}" }
            - { name: COLUMNS, value: "140" }
            - { name: REDIS_HOST, value: "cache-server" }
            - { name: FREVA_REST_URL, value: "http://freva-rest-server:{{ freva_rest_port }}" }
            - name: REDIS_PASSWD
              valueFrom: { secretKeyRef: { name: freva-secrets, key: REDIS_PASSWORD } }
            - name: REDIS_USER
              valueFrom: { secretKeyRef: { name: freva-secrets, key: REDIS_USERNAME } }
            - { name: OIDC_DISCOVERY_URL, value: "{{ web_oidc_url }}" }
            - name: OIDC_CLIENT_SECRET
              valueFrom: { secretKeyRef: { name: freva-secrets, key: OIDC_CLIENT_SECRET_WEB } }
            - { name: OIDC_CLIENT_ID, value: "{{ web_oidc_client }}" }
            - { name: CHATBOT_HOST, value: "{{ web_chatbot_host.replace('http://','') }}" }
            - { name: STAC_BROWSER, value: "1" }
            - { name: DB_USER, value: "{{ db_user }}" }
            - name: DB_PASSWD
              valueFrom: { secretKeyRef: { name: freva-secrets, key: MYSQL_PASSWORD } }
            - { name: DB_NAME, value: "{{ db }}" }
            - { name: DB_HOST, value: "database-server" }
            - { name: VAULT_URL, value: "http://vault-server:5002" }
          command: ["bash","-c","sleep 20 && ./init_django.sh"]
          volumeMounts:
{% if use_core %}
            - { name: core-root, mountPath: "{{ core_root_dir }}", readOnly: true }
            - { name: core-out,  mountPath: "{{ core_scheduler_output_dir }}", readOnly: true }
{% endif %}
            - { name: web-static, mountPath: /opt/freva_web/static }
            - { name: web-config, mountPath: /data/config }
            - { name: web-logs,   mountPath: /data/logs }
      volumes:
        - name: web-static
          emptyDir: {}
        - name: web-config
          persistentVolumeClaim: { claimName: web-config }
        - name: web-logs
          persistentVolumeClaim: { claimName: web-logs }
        - name: wait-script
          configMap: { name: wait-utils, defaultMode: 0755 }
{% if use_core %}
        - name: core-root
          hostPath: { path: "{{ core_root_dir }}", type: Directory }
        - name: core-out
          hostPath: { path: "{{ core_scheduler_output_dir }}", type: Directory }
{% endif %}
